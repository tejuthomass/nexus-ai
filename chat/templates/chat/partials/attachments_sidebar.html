<!-- Right Sidebar - Attachments Pane -->
<div class="w-[280px] bg-[#171717] flex flex-col border-l border-white/5 hidden lg:flex">
    <div class="p-4 border-b border-white/5">
        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider flex items-center gap-2">
            <i class="fas fa-paperclip"></i>
            Attachments
        </h3>
    </div>
    
    <!-- File Upload Section -->
    <div class="p-3 border-b border-white/5">
        <form id="pdf-upload-form" 
              hx-post="{% url 'chat_session' session.id %}" 
              hx-encoding="multipart/form-data"
              hx-target="#attachments-list"
              hx-swap="innerHTML"
              hx-on::before-request="showUploadIndicator(); disableChatInput()"
              hx-on::after-request="hideUploadIndicator(); enableChatInput(); resetFileInput();"
              class="space-y-2">
            {% csrf_token %}
            
            <!-- Upload Indicator -->
            <div id="sidebar-upload-indicator" class="mb-2 p-2 bg-blue-500/10 border border-blue-500/30 rounded-lg hidden">
                <div class="flex items-center gap-2 text-xs">
                    <i class="fas fa-circle-notch fa-spin text-blue-400"></i>
                    <span class="text-blue-300">Processing PDF...</span>
                </div>
            </div>
            
            <!-- Upload Button -->
            <label for="sidebar-pdf-upload" class="flex items-center justify-center gap-2 px-3 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg cursor-pointer transition-all duration-200 text-sm font-medium">
                <i class="fas fa-upload"></i>
                <span>Upload PDF</span>
            </label>
            <input type="file" 
                   id="sidebar-pdf-upload" 
                   name="pdf_file" 
                   accept=".pdf" 
                   class="hidden"
                   onchange="validateAndUploadFile(this)">
            
            <!-- File Info -->
            <div id="file-label" class="text-xs text-gray-500 text-center min-h-[16px]"></div>
            
            <!-- Size Limit Info -->
            <div class="text-xs text-gray-600 text-center">
                <i class="fas fa-info-circle"></i> Max size: 5MB
            </div>
        </form>
        
        <!-- Error/Success Messages -->
        <div id="upload-message" class="mt-2"></div>
    </div>
    
    <!-- Attachments List -->
    <div id="attachments-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
        {% include 'chat/partials/attachments_list.html' with documents=documents %}
    </div>
</div>

<script>
const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5MB
const MAX_FILE_SIZE_MB = 5;

function updateFileLabel(filename) {
    const label = document.getElementById('file-label');
    if (filename) {
        label.textContent = filename.length > 25 ? filename.substring(0, 25) + '...' : filename;
        label.classList.add('text-green-400');
    } else {
        label.textContent = '';
        label.classList.remove('text-green-400');
    }
}

function showUploadIndicator() {
    const indicator = document.getElementById('sidebar-upload-indicator');
    if (indicator) {
        indicator.classList.remove('hidden');
    }
}

function hideUploadIndicator() {
    const indicator = document.getElementById('sidebar-upload-indicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
}

function resetFileInput() {
    const fileInput = document.getElementById('sidebar-pdf-upload');
    if (fileInput) {
        fileInput.value = '';
    }
    updateFileLabel('');
}

function validateAndUploadFile(input) {
    const file = input.files[0];
    const messageDiv = document.getElementById('upload-message');
    const form = document.getElementById('pdf-upload-form');
    
    // Clear previous messages
    messageDiv.innerHTML = '';
    
    if (!file) return;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        showErrorMessage(messageDiv, '‚ùå Invalid file type. Only PDF files are allowed.');
        input.value = '';
        return;
    }
    
    // Validate file size
    if (file.size > MAX_FILE_SIZE_BYTES) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        showErrorMessage(
            messageDiv,
            '‚ùå File too large!<br><br>üìä File size: ' + fileSizeMB + 'MB<br>üìè Maximum allowed: ' + MAX_FILE_SIZE_MB + 'MB<br><br>üí° Try compressing the PDF or splitting it into smaller files.'
        );
        input.value = '';
        updateFileLabel('');
        return;
    }
    
    // File is valid, show filename and processing indicator
    updateFileLabel(file.name);
    showUploadIndicator();
    disableChatInput();
    
    // Create FormData and submit
    const formData = new FormData(form);
    const sessionId = window.location.pathname.split('/')[2];
    
    fetch('/chat/' + sessionId + '/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Update the attachments list
        const listContainer = document.getElementById('attachments-list');
        listContainer.innerHTML = html;
        
        // Show success notification using the centralized notification system
        // The notification will auto-dismiss after 4 seconds
        showNotification('‚úì PDF uploaded successfully!', 'success', 4000);
    })
    .catch(error => {
        console.error('Upload failed:', error);
        showErrorMessage(messageDiv, '‚ùå Upload failed. Please try again.');
    })
    .finally(() => {
        hideUploadIndicator();
        enableChatInput();
        resetFileInput();
    });
}

function disableChatInput() {
    const textarea = document.querySelector('textarea[name="message"]');
    const submitBtn = document.querySelector('button[type="submit"]');
    if (textarea) {
        textarea.disabled = true;
        textarea.placeholder = "Processing PDF, please wait...";
    }
    if (submitBtn) {
        submitBtn.disabled = true;
    }
}

function enableChatInput() {
    const textarea = document.querySelector('textarea[name="message"]');
    const submitBtn = document.querySelector('button[type="submit"]');
    if (textarea) {
        textarea.disabled = false;
        textarea.placeholder = "Message Nexus...";
    }
    if (submitBtn) {
        submitBtn.disabled = false;
    }
}

function showErrorMessage(container, message) {
    container.innerHTML = `
        <div class="p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-xs text-red-300">
            ${message}
        </div>
    `;
}
</script>
