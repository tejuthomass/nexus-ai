<!-- Right Sidebar - Attachments Pane -->
<div class="w-[280px] bg-gradient-to-b from-[#12121a] to-[#0a0a0f] flex flex-col border-l border-white/5 hidden lg:flex shadow-2xl">
    <div class="p-4 border-b border-white/5 bg-gradient-to-r from-indigo-500/8 to-violet-600/8">
        <h3 class="text-xs font-bold text-zinc-300 uppercase tracking-wider flex items-center gap-2">
            <i class="fas fa-paperclip text-indigo-400"></i>
            Attachments
        </h3>
    </div>
    
    <!-- File Upload Section -->
    <div class="p-3 border-b border-white/5">
        <form id="pdf-upload-form" 
              hx-post="{% url 'chat_session' session.id %}" 
              hx-encoding="multipart/form-data"
              hx-target="#attachments-list"
              hx-swap="innerHTML"
              hx-on::before-request="showUploadIndicator(); disableChatInput()"
              hx-on::after-request="hideUploadIndicator(); enableChatInput(); resetFileInput();"
              class="space-y-3">
            {% csrf_token %}
            
            <!-- Upload Indicator -->
            <div id="sidebar-upload-indicator" class="mb-2 p-3 bg-indigo-500/10 border border-indigo-500/30 rounded-xl hidden shadow-lg">
                <div class="flex items-center gap-2 text-xs">
                    <i class="fas fa-circle-notch fa-spin text-indigo-400"></i>
                    <span class="text-indigo-300 font-medium">Processing PDF...</span>
                </div>
            </div>
            
            <!-- Upload Button -->
            <label for="sidebar-pdf-upload" class="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white rounded-xl cursor-pointer transition-all duration-300 text-sm font-bold shadow-lg hover:shadow-xl hover:shadow-indigo-500/30 transform hover:scale-[1.02] active:scale-[0.98]">
                <i class="fas fa-upload"></i>
                <span>Upload PDF</span>
            </label>
            <input type="file" 
                   id="sidebar-pdf-upload" 
                   name="pdf_file" 
                   accept=".pdf" 
                   class="hidden"
                   onchange="validateAndUploadFile(this)">
            
            <!-- File Info -->
            <div id="file-label" class="text-xs text-zinc-500 text-center min-h-[16px] font-medium"></div>
            
            <!-- Size Limit Info -->
            <div class="text-xs text-zinc-600 text-center flex items-center justify-center gap-2">
                <i class="fas fa-info-circle text-indigo-400"></i> 
                <span>Max size: 5MB</span>
            </div>
        </form>

</div>

<script>
const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5MB
const MAX_FILE_SIZE_MB = 5;

function updateFileLabel(filename) {
    const label = document.getElementById('file-label');
    if (filename) {
        label.textContent = filename.length > 25 ? filename.substring(0, 25) + '...' : filename;
        label.classList.add('text-indigo-400');
    } else {
        label.textContent = '';
        label.classList.remove('text-indigo-400');
    }
}

function showUploadIndicator() {
    const indicator = document.getElementById('sidebar-upload-indicator');
    if (indicator) {
        indicator.classList.remove('hidden');
    }
}

function hideUploadIndicator() {
    const indicator = document.getElementById('sidebar-upload-indicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
}

function resetFileInput() {
    const fileInput = document.getElementById('sidebar-pdf-upload');
    if (fileInput) {
        fileInput.value = '';
    }
    updateFileLabel('');
}

function validateAndUploadFile(input) {
    const file = input.files[0];
    const form = document.getElementById('pdf-upload-form');
    
    if (!file) return;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        showNotification('Invalid file type. Only PDF files are allowed.', 'error', 5000);
        input.value = '';
        return;
    }
    
    // Validate file size
    if (file.size > MAX_FILE_SIZE_BYTES) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        showNotification(
            'File too large! Size: ' + fileSizeMB + 'MB (Max: ' + MAX_FILE_SIZE_MB + 'MB). Try compressing or splitting the PDF.',
            'error',
            6000
        );
        input.value = '';
        updateFileLabel('');
        return;
    }
    
    // File is valid, show filename and processing indicator
    updateFileLabel(file.name);
    showUploadIndicator();
    disableChatInput();
    
    // Create FormData and submit
    const formData = new FormData(form);
    const sessionId = window.location.pathname.split('/')[2];
    
    fetch('/chat/' + sessionId + '/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Update the attachments list
        const listContainer = document.getElementById('attachments-list');
        listContainer.innerHTML = html;
        
        // Show success notification using the centralized notification system
        // The notification will auto-dismiss after 4 seconds
        showNotification('âœ“ PDF uploaded successfully!', 'success', 4000);
    })
    .catch(error => {
        console.error('Upload failed:', error);
        showNotification('Upload failed. Please try again.', 'error', 5000);
    })
    .finally(() => {
        hideUploadIndicator();
        enableChatInput();
        resetFileInput();
    });
}

function disableChatInput() {
    const textarea = document.querySelector('textarea[name="message"]');
    const submitBtn = document.querySelector('button[type="submit"]');
    if (textarea) {
        textarea.disabled = true;
        textarea.placeholder = "Processing PDF, please wait...";
    }
    if (submitBtn) {
        submitBtn.disabled = true;
    }
}

function enableChatInput() {
    const textarea = document.querySelector('textarea[name="message"]');
    const submitBtn = document.querySelector('button[type="submit"]');
    if (textarea) {
        textarea.disabled = false;
        textarea.placeholder = "Message Nexus...";
    }
    if (submitBtn) {
        submitBtn.disabled = false;
    }
}
</script>
