<!-- Admin Chat Modal Overlay -->
<div id="admin-chat-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fadeIn" onclick="if(event.target === this) document.getElementById('admin-chat-modal').classList.add('hidden')">
    <div class="bg-gradient-to-br from-[#1a1a24] to-[#0a0a0f] rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col border border-white/20 overflow-hidden" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-white/20 bg-gradient-to-r from-indigo-500/10 to-violet-500/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-xl shadow-indigo-500/30">
                    <i class="fas fa-comments text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white" id="admin-modal-title">Chat History</h2>
                    <p class="text-xs text-zinc-400 mt-1 font-medium" id="admin-modal-user">User: â€”</p>
                </div>
            </div>
            <button type="button" onclick="document.getElementById('admin-chat-modal').classList.add('hidden')" class="text-zinc-400 hover:text-white transition-colors p-3 hover:bg-white/10 rounded-xl">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="flex flex-1 gap-4 overflow-hidden">
            <!-- Chat Messages Area -->
            <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-[#12121a]">
                <div id="admin-modal-messages">
                    <div class="flex justify-center items-center h-full">
                        <div class="text-center space-y-2">
                            <i class="fas fa-circle-notch fa-spin text-2xl text-zinc-500"></i>
                            <p class="text-zinc-500 text-sm">Loading conversation...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attachments Sidebar in Modal -->
            <div class="w-[280px] bg-[#1a1a24] border-l border-white/10 flex flex-col">
                <div class="p-4 border-b border-white/10">
                    <h3 class="text-xs font-semibold text-zinc-400 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-paperclip text-indigo-400"></i>
                        Attachments
                    </h3>
                </div>
                <div class="flex-1 overflow-y-auto p-3 space-y-2">
                    <div id="admin-modal-attachments">
                        <div class="flex items-center justify-center h-full text-center py-12">
                            <div class="space-y-2">
                                <i class="fas fa-inbox text-3xl text-zinc-600"></i>
                                <p class="text-xs text-zinc-500">No attachments</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-4 border-t border-white/10 bg-[#1a1a24] flex items-center justify-between">
            <div class="text-xs text-zinc-500">
                <i class="fas fa-info-circle mr-1"></i>
                Read-only view
            </div>
            <button type="button" onclick="document.getElementById('admin-chat-modal').classList.add('hidden')" class="px-5 py-2.5 bg-white/10 hover:bg-white/15 text-zinc-300 rounded-lg font-medium transition flex items-center gap-2">
                <i class="fas fa-times"></i>
                Close
            </button>
        </div>
    </div>
</div>

<script>
function openAdminChatModal(sessionId) {
    const modal = document.getElementById('admin-chat-modal');
    const messagesContainer = document.getElementById('admin-modal-messages');
    const attachmentsContainer = document.getElementById('admin-modal-attachments');
    
    // Show modal immediately
    modal.classList.remove('hidden');
    
    // Reset to loading state
    messagesContainer.innerHTML = `
        <div class="flex justify-center items-center h-full">
            <div class="text-center space-y-2">
                <i class="fas fa-circle-notch fa-spin text-2xl text-zinc-500"></i>
                <p class="text-zinc-500 text-sm">Loading conversation...</p>
            </div>
        </div>
    `;
    
    // Fetch the admin chat data
    fetch(`/chat/api/admin-chat/${sessionId}/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load chat');
            }
            return response.json();
        })
        .then(data => {
            // Update modal header
            document.getElementById('admin-modal-title').textContent = data.title || 'Chat History';
            document.getElementById('admin-modal-user').textContent = `User: ${data.user}`;
            
            // Populate messages with improved styling
            if (data.messages && data.messages.length > 0) {
                messagesContainer.innerHTML = data.messages.map(msg => {
                    if (msg.role === 'user') {
                        return `
                            <div class="flex justify-end animate-[fadeIn_0.3s_ease-out_forwards]">
                                <div class="max-w-[85%] bg-gradient-to-br from-indigo-600/80 to-violet-600/70 text-white px-5 py-3.5 rounded-2xl rounded-tr-lg shadow-xl shadow-indigo-500/20 border border-indigo-500/40">
                                    <div class="text-[15px] leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.content)}</div>
                                    <div class="text-xs text-indigo-200/70 mt-2">${formatDate(msg.created_at)}</div>
                                </div>
                            </div>
                        `;
                    }
                    const html = msg.html_content || escapeHtml(msg.content || '');
                    return `
                        <div class="flex gap-4 animate-[fadeIn_0.3s_ease-out_forwards]">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 via-violet-500 to-purple-600 flex-shrink-0 flex items-center justify-center text-white text-xs mt-1 shadow-lg shadow-indigo-500/30">
                                <i class="fas fa-zap"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-sm text-indigo-400 mb-2">Nexus</div>
                                <div class="prose prose-invert max-w-none text-zinc-200 text-[15px] leading-relaxed">
                                    ${html}
                                </div>
                                <div class="text-xs text-zinc-600 mt-2">${formatDate(msg.created_at)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                messagesContainer.innerHTML = '<p class="text-zinc-500 text-sm text-center py-8">No messages in this conversation.</p>';
            }
            
            // Populate attachments with improved styling
            if (data.documents && data.documents.length > 0) {
                attachmentsContainer.innerHTML = data.documents.map(doc => `
                    <a href="${doc.file_url}" target="_blank" class="flex items-center gap-3 p-3 rounded-lg bg-white/[0.04] border border-white/8 hover:border-indigo-500/40 hover:bg-indigo-500/8 transition group">
                        <i class="fas fa-file-pdf text-indigo-400 text-lg flex-shrink-0"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-zinc-300 truncate group-hover:text-white transition font-medium">${escapeHtml(doc.title)}</p>
                            <p class="text-xs text-zinc-600">${formatDate(doc.uploaded_at)}</p>
                        </div>
                        <i class="fas fa-download text-zinc-600 group-hover:text-indigo-400 transition opacity-0 group-hover:opacity-100"></i>
                    </a>
                `).join('');
            } else {
                attachmentsContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full text-center py-8">
                        <div class="space-y-2">
                            <i class="fas fa-inbox text-3xl text-zinc-600"></i>
                            <p class="text-xs text-zinc-500">No attachments</p>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading chat:', error);
            messagesContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-400 mb-3"></i>
                    <p class="text-red-400 text-sm font-medium">Failed to load chat details</p>
                    <p class="text-zinc-500 text-xs mt-1">${error.message}</p>
                </div>
            `;
        });
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to format dates
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit'
    });
}
</script>
